name: Release Helm Chart

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.13.0

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Update Chart version
        run: |
          sed -i "s/^version:.*/version: ${{ steps.get_version.outputs.VERSION }}/" Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.get_version.outputs.VERSION }}\"/" Chart.yaml
          cat Chart.yaml

      - name: Update values.yaml with new image tag
        run: |
          sed -i "s/tag: .*/tag: \"${{ steps.get_version.outputs.VERSION }}\"/" values.yaml

      - name: Package Helm chart
        run: |
          helm package . --destination .deploy
          ls -la .deploy/

      - name: Generate chart README
        run: |
          cat > .deploy/README.md <<EOF
          # Maintenance Operator Helm Chart

          Version: ${{ steps.get_version.outputs.VERSION }}

          ## Installation

          \`\`\`bash
          helm install maintenance-operator \\
            https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.VERSION }}/maintenance-operator-${{ steps.get_version.outputs.VERSION }}.tgz \\
            --namespace maintenance-operator \\
            --create-namespace
          \`\`\`

          ## Using with OCI Registry

          \`\`\`bash
          helm install maintenance-operator oci://ghcr.io/${{ github.repository }}/charts/maintenance-operator \\
            --version ${{ steps.get_version.outputs.VERSION }} \\
            --namespace maintenance-operator \\
            --create-namespace
          \`\`\`
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            .deploy/*.tgz
            .deploy/README.md
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to GitHub Container Registry (OCI)
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push chart to OCI registry
        run: |
          helm push .deploy/maintenance-operator-${{ steps.get_version.outputs.VERSION }}.tgz oci://ghcr.io/${{ github.repository_owner }}/charts
